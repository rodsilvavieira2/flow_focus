# Flatpak manifest for Flow Focus - Downloads from GitHub Releases (Manual SHA256 version)
# This version requires you to manually update the SHA256 checksums for each release
app-id: com.rodrigo.flow_focus
runtime: org.gnome.Platform
runtime-version: '47'
sdk: org.gnome.Sdk
command: flow_focus

finish-args:
  # Allow access to the desktop
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  
  # Allow desktop notifications
  - --talk-name=org.freedesktop.Notifications
  
  # Allow access to sound for notification sounds
  - --socket=pulseaudio
  
  # Allow access to settings/preferences
  - --filesystem=xdg-config/flow_focus:create
  
  # Allow system tray access
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.StatusNotifierWatcher
  
  # Additional system permissions for proper library access
  - --share=network
  - --device=dri

modules:
  - name: flow_focus
    buildsystem: simple
    build-commands:
      # Create the application directory structure
      - mkdir -p /app/bin
      - mkdir -p /app/share/applications
      - mkdir -p /app/share/metainfo
      - mkdir -p /app/share/icons/hicolor/256x256/apps
      
      # Extract the downloaded release archive
      - tar -xzf flow_focus-linux-x64.tar.gz
      
      # Copy the precompiled Flutter app from extracted bundle
      - cp -r bundle/* /app/
      
      # Make the executable... executable
      - chmod +x /app/flow_focus
      
      # Create a wrapper script for proper execution
      - |
        cat > /app/bin/flow_focus << 'EOF'
        #!/bin/bash
        export FLUTTER_ROOT=/app
        export LD_LIBRARY_PATH=/app/lib:$LD_LIBRARY_PATH
        # Ensure runtime libraries are available
        export PATH=/app/bin:$PATH
        exec /app/flow_focus "$@"
        EOF
      - chmod +x /app/bin/flow_focus
      
      # Install desktop file and metadata
      - install -Dm644 com.rodrigo.flow_focus.desktop /app/share/applications/
      - install -Dm644 com.rodrigo.flow_focus.metainfo.xml /app/share/metainfo/
      
      # Install icon
      - install -Dm644 app_icon.png /app/share/icons/hicolor/256x256/apps/com.rodrigo.flow_focus.png
      
    sources:
      # Download a specific release from GitHub
      # INSTRUCTIONS TO UPDATE:
      # 1. Replace 'yourusername' with your GitHub username
      # 2. Replace 'linux-1' with the actual tag of your release
      # 3. Calculate and update all SHA256 checksums
      #
      # To calculate SHA256: curl -sL <URL> | sha256sum
      
      - type: archive
        url: https://github.com/yourusername/flow_focus/releases/download/linux-1/flow_focus-linux-x64.tar.gz
        sha256: REPLACE_WITH_ACTUAL_SHA256_OF_ARCHIVE
        
      # Include the desktop file and metadata from the repository
      - type: file
        url: https://raw.githubusercontent.com/yourusername/flow_focus/master/com.rodrigo.flow_focus.desktop
        sha256: REPLACE_WITH_ACTUAL_SHA256_OF_DESKTOP_FILE
        
      - type: file
        url: https://raw.githubusercontent.com/yourusername/flow_focus/master/com.rodrigo.flow_focus.metainfo.xml
        sha256: REPLACE_WITH_ACTUAL_SHA256_OF_METAINFO_FILE
        
      # Include the app icon from the repository
      - type: file
        url: https://raw.githubusercontent.com/yourusername/flow_focus/master/assets/icons/app_icon.png
        sha256: REPLACE_WITH_ACTUAL_SHA256_OF_ICON_FILE
        dest-filename: app_icon.png
